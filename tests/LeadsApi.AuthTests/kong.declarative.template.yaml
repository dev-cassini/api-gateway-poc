_format_version: "3.0"
services:
  - name: leads-api
    url: http://{{UPSTREAM_HOST}}:{{UPSTREAM_PORT}}
    plugins:
      - name: pre-function
        config:
          access:
            - |
              local function deny(status, message)
                return kong.response.exit(status, { message = message })
              end

              local function base64_url_decode(input)
                if not input then
                  return nil
                end

                local normalized = input:gsub("-", "+"):gsub("_", "/")
                local padding = #normalized % 4
                if padding == 2 then
                  normalized = normalized .. "=="
                elseif padding == 3 then
                  normalized = normalized .. "="
                elseif padding == 1 then
                  return nil
                end

                return ngx.decode_base64(normalized)
              end

              local auth = kong.request.get_header("authorization")
              if not auth then
                return deny(401, "Missing authorization header")
              end

              local token = auth:match("^[Bb]earer%s+(.+)$")
              if not token then
                return deny(401, "Invalid authorization header")
              end

              local header_b64, payload_b64 = token:match("^([^.]+)%.([^.]+)%.([^.]+)$")
              if not header_b64 or not payload_b64 then
                return deny(401, "Malformed JWT")
              end

              local payload_json = base64_url_decode(payload_b64)
              if not payload_json then
                return deny(401, "Invalid JWT payload encoding")
              end

              local roles = {}
              local role_single = payload_json:match('"role"%s*:%s*"([^"]+)"')
              if role_single then
                roles[string.lower(role_single)] = true
              end

              local role_array = payload_json:match('"role"%s*:%s*%[([^%]]+)%]')
              if role_array then
                for role in string.gmatch(role_array, '"([^"]+)"') do
                  roles[string.lower(role)] = true
                end
              end

              if next(roles) == nil then
                return deny(401, "Token does not contain roles")
              end

              local scopes = {}
              local scope_single = payload_json:match('"scope"%s*:%s*"([^"]+)"')
              if scope_single then
                for scope in string.gmatch(scope_single, "[^,%s]+") do
                  scopes[scope] = true
                end
              end

              local scope_array = payload_json:match('"scp"%s*:%s*%[([^%]]+)%]')
              if scope_array then
                for scope in string.gmatch(scope_array, '"([^"]+)"') do
                  scopes[scope] = true
                end
              end

              local method = kong.request.get_method()
              local path = kong.request.get_path()

              if method == "POST" and path == "/leads" then
                if not scopes["leads:import"] then
                  return deny(403, "Missing required scope: leads:import")
                end
                return
              end

              if method == "GET" and string.match(path, "^/leads/[0-9a-fA-F%-]+$") then
                if not roles["adviser"] and not roles["customer"] then
                  return deny(403, "Missing required role")
                end
                return
              end

              if method == "POST" and string.match(path, "^/leads/[0-9a-fA-F%-]+/assign$") then
                if not roles["adviser"] then
                  return deny(403, "Missing required role: adviser")
                end
                return
              end
    routes:
      - name: create-lead
        methods: ["POST"]
        paths: ["~/leads$"]
        strip_path: false
      - name: get-lead
        methods: ["GET"]
        paths: ["~/leads/[0-9a-fA-F-]+$"]
        strip_path: false
      - name: assign-lead
        methods: ["POST"]
        paths: ["~/leads/[0-9a-fA-F-]+/assign$"]
        strip_path: false
